name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR stats
        id: stats
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{s+=$1} END {print s}')
          LINES_REMOVED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{s+=$2} END {print s}')
          TOTAL_CHANGES=$((LINES_ADDED + LINES_REMOVED))

          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "added=$LINES_ADDED" >> $GITHUB_OUTPUT
          echo "removed=$LINES_REMOVED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_CHANGES" >> $GITHUB_OUTPUT

      - name: Comment PR size
        uses: actions/github-script@v7
        with:
          script: |
            const files = parseInt('${{ steps.stats.outputs.files }}');
            const added = parseInt('${{ steps.stats.outputs.added }}');
            const removed = parseInt('${{ steps.stats.outputs.removed }}');
            const total = parseInt('${{ steps.stats.outputs.total }}');

            let sizeEmoji = 'ğŸŸ¢';
            let sizeLabel = 'Small';
            let recommendation = 'âœ… ì´ìƒì ì¸ PR í¬ê¸°ì…ë‹ˆë‹¤!';

            if (total > 500) {
              sizeEmoji = 'ğŸ”´';
              sizeLabel = 'Huge';
              recommendation = 'âš ï¸ PRì´ ë„ˆë¬´ í½ë‹ˆë‹¤. ì—¬ëŸ¬ ê°œë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ì£¼ì„¸ìš”.';
            } else if (total > 300) {
              sizeEmoji = 'ğŸŸ ';
              sizeLabel = 'Large';
              recommendation = 'âš ï¸ PR í¬ê¸°ê°€ í½ë‹ˆë‹¤. ê°€ëŠ¥í•˜ë©´ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ì£¼ì„¸ìš”.';
            } else if (total > 100) {
              sizeEmoji = 'ğŸŸ¡';
              sizeLabel = 'Medium';
              recommendation = 'âœ… ì ì ˆí•œ PR í¬ê¸°ì…ë‹ˆë‹¤.';
            }

            const body = `## ğŸ“Š PR í†µê³„

            ${sizeEmoji} **í¬ê¸°**: ${sizeLabel}

            - ğŸ“ ë³€ê²½ëœ íŒŒì¼: **${files}ê°œ**
            - â• ì¶”ê°€ëœ ì¤„: **${added}ì¤„**
            - â– ì‚­ì œëœ ì¤„: **${removed}ì¤„**
            - ğŸ“ ì´ ë³€ê²½: **${total}ì¤„**

            ${recommendation}

            ---
            <sub>ğŸ’¡ **íŒ**: ì‘ì€ PRì¼ìˆ˜ë¡ ë¦¬ë·°ê°€ ë¹ ë¥´ê³  ë³‘í•© í™•ë¥ ì´ ë†’ìŠµë‹ˆë‹¤!</sub>
            `;

            // ê¸°ì¡´ bot ì½”ë©˜íŠ¸ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š PR í†µê³„')
            );

            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

      - name: Fail if too large
        if: steps.stats.outputs.total > 1000
        run: |
          echo "::error::PR is too large (> 1000 lines changed). Please split into smaller PRs."
          exit 1

  file-size-check:
    name: Check File Sizes
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for large files
        run: |
          # 1MB ì´ìƒ íŒŒì¼ ì°¾ê¸°
          LARGE_FILES=$(find . -type f -size +1M -not -path "./.git/*" -not -path "./node_modules/*")

          if [ -n "$LARGE_FILES" ]; then
            echo "::warning::Found large files (> 1MB):"
            echo "$LARGE_FILES"
            echo "::warning::Consider using Git LFS for large binary files"
          fi

  conventional-commits:
    name: Check Conventional Commits
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        uses: wagoid/commitlint-github-action@v5
        with:
          configFile: .commitlintrc.json
